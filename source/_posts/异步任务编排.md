---
title: 异步任务编排
date: 2024-07-27 06:02:52
tags:
- java
categories:
- 后端
cover: /images/background/li.jpeg
coverWidth: 1200
coverHeight: 320
author: 不二
---

CompletableFuture异步任务编排
<!-- more -->

#### **Callable**

线程创建的几种方式，继承`Thread`类，实现`Callable`接口或`Runnable`接口。只有`Callable`接口支持返回值，可以拿到线程的状态，这也是线程异步任务编排的基础。

```java
public class CallableDemo implements Callable {

    @Override
    public String call() throws Exception {
        System.out.println(Thread.currentThread().getName() + "线程执行执行");
        return Thread.currentThread().getName() + "over";
    }

    public static void main(String[] args) throws ExecutionException, InterruptedException {
        CallableDemo callableDemo = new CallableDemo();
        FutureTask<CallableDemo> callableDemoFutureTask = new FutureTask<CallableDemo>(callableDemo);
        new Thread(callableDemoFutureTask).start();
        System.out.println(callableDemoFutureTask.get());
    }

}
```

虽然可以拿到返回值，但是要使用这个去操作线程的启停。还是很麻烦的

#### CompletableFuture

`CompletableFuture` 是 Java 8 引入的，用于支持异步编程的类。它允许你编排异步任务，并处理结果或异常。

`CompletableFuture`实现了`Future`接口，并在此基础上进行了丰富的扩展，完美弥补了`Future`的局限性，**同时`CompletableFuture`实现了对任务编排的能力**

##### 构造方法

`runAsyncm`没有返回值 `supplyAsync`有返回值, `executor`用来指定线程池，不指定使用默认的线程池。

```java
public static CompletableFuture<Void> runAsync(Runnable runnable)
public static CompletableFuture<Void> runAsync(Runnable runnable, Executor executor)
public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier)
public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor)
```

##### 获取结果

join()和get()方法都是用来获取CompletableFuture异步之后的返回值。

######  异常处理

- **`get()`**：在获取结果时，如果任务以异常结束，`get()` 会抛出 `ExecutionException`，需要额外处理。
- **`join()`**：在获取结果时，如果任务以异常结束，`join()` 会抛出 `CompletionException`，更简单地封装了异常。

######  阻塞行为

- 两者都将阻塞调用线程，直到结果可用，但 `get()` 可以指定超时时间，而 `join()` 不支持超时

##### 结果处理

- 方法不以`Async`结尾，意味着Action使用相同的线程执行，而`Async`可能会使用其它的线程去执行(如果使用相同的线程池，也可能会被同一个线程选中执行)。

```java
public CompletableFuture<T> whenComplete(BiConsumer<? super T,? super Throwable> action)
public CompletableFuture<T> whenCompleteAsync(BiConsumer<? super T,? super Throwable> action)
public CompletableFuture<T> whenCompleteAsync(BiConsumer<? super T,? super Throwable> action, Executor executor)
```

